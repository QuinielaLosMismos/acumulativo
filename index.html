/***********************
 * QUINIELA LOS MISMOS
 * Code.gs (ESTABLE + Reemplazo + Padrón J1+J2 desde J3 + Nombre MAYÚSCULAS sin acentos
 *          + Formato Aciertos/Ganadores + Banner + Acumulado PODIO con empates)
 ***********************/
const SPREADSHEET_ID = '1KEZajlAhdP6kVflxSY5sMjArNwnvjx6Fnz75DUkTMgU';
const SHEET_CONFIG   = 'CONFIG';
const SHEET_RESP     = 'RESPUESTAS';
const MAX_PARTIDOS   = 13;

// Colores
const COLOR_ACIERTO  = '#c6efce'; // verde claro (aciertos y nombre ganador por jornada)
const COLOR_LIMPIO   = '#ffffff'; // blanco

// Podio (verdes similares al 1er lugar)
const COLOR_TOP1 = '#63be7b';
const COLOR_TOP2 = '#7fcf90';
const COLOR_TOP3 = '#9be0ab';

// Banner por jornada
const BANNER_MARKER_TEL = '__BANNER__'; // marcador interno
const COLOR_BANNER_JORNADA  = '#ddebf7'; // azul suave
const ACERTOS_BANNER_SORT   = 9999;      // para ordenar (se oculta)

// Acumulado (tabla a la derecha)
const ACUM_COL_START = 22; // Columna V (A=1)
const ACUM_JORNADAS  = 17; // J1..J17

/* ========= Helpers ========= */
function ss_(){ return SpreadsheetApp.openById(SPREADSHEET_ID); }

function json_(obj){
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function col_(headers, name){
  const idx = headers.indexOf(name);
  if (idx < 0) throw new Error(`Falta columna: ${name}`);
  return idx + 1;
}

function parseMoney_(v){
  return Number(String(v||'').replace(/[^0-9.]/g,'')) || 0;
}

// Solo acepta L/E/V. Cualquier otra cosa => '' (vacío)
function normLEV_(v){
  const s = String(v ?? '').trim().toUpperCase();
  if (s === 'L' || s === 'E' || s === 'V') return s;
  return '';
}

// Normaliza (para comparar): sin acentos, espacios simples, lower
function normName_(v){
  let s = String(v ?? '').trim();
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // sin acentos
  s = s.replace(/\s+/g,' ').toLowerCase();
  return s;
}

// Mostrar/guardar: MAYÚSCULAS + sin acentos + espacios simples
function sanitizeNombre_(v){
  let s = String(v ?? '').trim();
  s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); // sin acentos
  s = s.replace(/\s+/g,' ');
  s = s.toUpperCase();
  return s;
}

// Interpreta jornada aunque venga como "Jornada 2" o "2"
function parseJornada_(v){
  const s = String(v ?? '').trim();
  if (!s) return null;
  const n = Number(s);
  if (Number.isFinite(n)) return n;
  const m = s.match(/(\d+)/);
  return m ? Number(m[1]) : null;
}

function esBannerRow_(row, cTel){
  return String(row?.[cTel-1] ?? '').trim() === BANNER_MARKER_TEL;
}

/* ========= Config ========= */
function readConfig_(){
  const sh = ss_().getSheetByName(SHEET_CONFIG);
  const lastRow = Math.max(sh.getLastRow(), 15);
  const grid = sh.getRange(1,1,lastRow,3).getValues();

  const kv = {};
  grid.forEach(r=>{
    if (r[0]) kv[String(r[0]).toLowerCase()] = r[1];
  });

  const subtitulo = String(kv['subtitulo'] || '');
  const m = subtitulo.match(/(\d+)/);
  const jornada = m ? Number(m[1]) : null;

  const partidos = [];
  const resultados = [];

  // Partidos desde fila 10: A=Local, B=Visitante, C=Resultado
  for (let r=10; r<=lastRow; r++){
    const local  = String(sh.getRange(r,1).getValue() || '').trim();
    const visita = String(sh.getRange(r,2).getValue() || '').trim();
    const res    = normLEV_(sh.getRange(r,3).getValue()); // si no es L/E/V queda vacío

    if (!local && !visita) continue;

    partidos.push({ local, visita });
    resultados.push(res);
  }

  return {
    activo: String(kv['activo'] || '').toUpperCase(),
    jornada,
    premioSemanal: parseMoney_(kv['premio semanal']),
    partidos,
    resultados,
  };
}

/* ========= RESPUESTAS: headers + fila 2 ========= */
function syncRespuestas_(){
  const sh = ss_().getSheetByName(SHEET_RESP);

  const headers = [
    'Jornada',
    'Timestamp',
    'Teléfono',
    'Nombre',
    ...Array.from({length: MAX_PARTIDOS}, (_,i)=>`p${i+1}`),
    'Aciertos',
    'NumGanadores',
    'PremioPorGanador',
  ];

  sh.getRange(1,1,1,headers.length).setValues([headers]);
  sh.setFrozenRows(1);

  if (sh.getLastRow() < 2) sh.insertRowAfter(1);

  const cfg = readConfig_();
  const row2 = new Array(headers.length).fill('');

  const start = headers.indexOf('p1');
  cfg.partidos.forEach((p,i)=>{
    if (i < MAX_PARTIDOS) row2[start + i] = `${p.local} vs ${p.visita}`;
  });

  sh.getRange(2,1,1,headers.length).setValues([row2]);
}

/* ========= Trigger (CONFIG) ========= */
function onEditConfig_(e){
  if (e.range.getSheet().getName() !== SHEET_CONFIG) return;
  syncRespuestas_();
}

function instalarTriggerConfig(){
  ScriptApp.getProjectTriggers().forEach(t=>{
    if (t.getHandlerFunction() === 'onEditConfig_') ScriptApp.deleteTrigger(t);
  });

  ScriptApp.newTrigger('onEditConfig_')
    .forSpreadsheet(SPREADSHEET_ID)
    .onEdit()
    .create();

  syncRespuestas_();
}

/* ========= Banner por jornada ========= */
function asegurarBannerJornada_(cfg){
  const sh = ss_().getSheetByName(SHEET_RESP);
  const lastRow = sh.getLastRow();
  const lastCol = sh.getLastColumn();

  const headers = sh.getRange(1,1,1,lastCol).getValues()[0];
  const cJ   = col_(headers,'Jornada');
  const cTs  = col_(headers,'Timestamp');
  const cTel = col_(headers,'Teléfono');
  const cP1  = col_(headers,'p1');
  const cA   = col_(headers,'Aciertos');
  const cNom = col_(headers,'Nombre');

  // ya hay banner o fila real
  if (lastRow >= 3){
    const data = sh.getRange(3,1,lastRow-2,lastCol).getValues();
    for (let i=0; i<data.length; i++){
      const j = parseJornada_(data[i][cJ-1]);
      if (j !== cfg.jornada) continue;
      if (esBannerRow_(data[i], cTel)) return;

      const nombre = String(data[i][cNom-1] ?? '').trim();
      const ts = String(data[i][cTs-1] ?? '').trim();
      if ((nombre || ts) && !esBannerRow_(data[i], cTel)) return;
    }
  }

  const banner = new Array(lastCol).fill('');
  banner[cJ-1]   = cfg.jornada;
  banner[cTs-1]  = `PARTIDOS JORNADA ${cfg.jornada}`;
  banner[cTel-1] = BANNER_MARKER_TEL;
  banner[cA-1]   = ACERTOS_BANNER_SORT;
  banner[cNom-1] = '';

  const n = Math.min(cfg.partidos.length, MAX_PARTIDOS);
  for (let i=0; i<n; i++){
    banner[(cP1-1)+i] = `${cfg.partidos[i].local} vs ${cfg.partidos[i].visita}`;
  }

  sh.appendRow(banner);

  const r = sh.getLastRow();
  sh.getRange(r,1,1,lastCol)
    .setBackground(COLOR_BANNER_JORNADA)
    .setFontWeight('bold');

  sh.getRange(r, cA).setNumberFormat(';;;');
}

/* ========= Buscar fila por nombre+jornada ========= */
function filaPorNombreYJornada_(nombre, jornada){
  const sh = ss_().getSheetByName(SHEET_RESP);
  const lastRow = sh.getLastRow();
  if (lastRow < 3) return null;

  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  const cNom = col_(headers,'Nombre');
  const cJor = col_(headers,'Jornada');
  const cTel = col_(headers,'Teléfono');

  const nombres = sh.getRange(3, cNom, lastRow-2, 1).getValues().flat();
  const jornadas = sh.getRange(3, cJor, lastRow-2, 1).getValues().flat();
  const tels = sh.getRange(3, cTel, lastRow-2, 1).getValues().flat();

  const targetName = normName_(nombre);
  const targetJ = Number(jornada);

  for (let i=0; i<nombres.length; i++){
    if (String(tels[i] ?? '').trim() === BANNER_MARKER_TEL) continue;
    if (normName_(nombres[i]) !== targetName) continue;
    const j = parseJornada_(jornadas[i]);
    if (j === targetJ) return 3 + i;
  }
  return null;
}

/* ========= Padrón: existe en Jornada 1 o 2 ========= */
function nombreExisteEnJornada1o2_(nombre){
  const sh = ss_().getSheetByName(SHEET_RESP);
  const lastRow = sh.getLastRow();
  if (lastRow < 3) return false;

  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  const cNom = col_(headers,'Nombre');
  const cJor = col_(headers,'Jornada');
  const cTel = col_(headers,'Teléfono');

  const target = normName_(nombre);
  const nombres = sh.getRange(3, cNom, lastRow-2, 1).getValues().flat();
  const jornadas = sh.getRange(3, cJor, lastRow-2, 1).getValues().flat();
  const tels = sh.getRange(3, cTel, lastRow-2, 1).getValues().flat();

  for (let i=0; i<nombres.length; i++){
    if (String(tels[i] ?? '').trim() === BANNER_MARKER_TEL) continue;
    const j = parseJornada_(jornadas[i]);
    if (j !== 1 && j !== 2) continue;
    if (normName_(nombres[i]) === target) return true;
  }
  return false;
}

/* ========= WebApp ========= */
function doGet(e){
  try{
    if (e?.parameter?.action !== 'getConfig') return json_({ ok:true });
    syncRespuestas_();
    return json_({ ok:true, ...readConfig_() });
  }catch(err){
    return json_({ ok:false, message:String(err) });
  }
}

function doPost(e){
  try{
    const data = JSON.parse(e.postData.contents || '{}');

    // ✅ Normalizar nombre: MAYÚSCULAS y sin acentos (servidor)
    const nombre  = sanitizeNombre_(data.nombre || '');
    const tel     = String(data.telefono || '').trim();
    const replace = data.replace === true;

    if (!nombre) return json_({ ok:false, message:'Falta nombre' });
    if (!tel)    return json_({ ok:false, message:'Falta teléfono' });

    const cfg = readConfig_();
    if (cfg.activo !== 'SI') return json_({ ok:false, message:'Quiniela inactiva' });
    if (!cfg.jornada)        return json_({ ok:false, message:'Jornada no definida' });

    // ✅ Regla padrón:
    // - Jornada 1: libre
    // - Jornada 2: libre (tu filtro manual)
    // - Jornada 3+: solo si existe en Jornada 1 o 2
    if (cfg.jornada >= 3){
      if (!nombreExisteEnJornada1o2_(nombre)){
        return json_({
          ok:false,
          message:'Este nombre no está registrado en Jornadas 1 o 2. Usa un nombre ya registrado.'
        });
      }
    }

    if (!Array.isArray(data.partidos) || data.partidos.length !== cfg.partidos.length){
      return json_({ ok:false, message:'Selecciones incompletas' });
    }

    const sh = ss_().getSheetByName(SHEET_RESP);
    const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];

    const fila = filaPorNombreYJornada_(nombre, cfg.jornada);

    if (fila && !replace){
      return json_({
        ok:false,
        code:'DUPLICATE',
        message:'Ya existe una quiniela con este nombre en esta jornada. ¿Quieres reemplazarla?'
      });
    }

    const row = new Array(headers.length).fill('');
    row[col_(headers,'Jornada')-1]    = cfg.jornada;
    row[col_(headers,'Timestamp')-1]  = new Date();
    row[col_(headers,'Nombre')-1]     = nombre; // ✅ ya viene en MAYÚSCULAS sin acentos
    row[col_(headers,'Teléfono')-1]   = tel;

    // Guardar picks: solo L/E/V
    data.partidos.forEach((p,i)=>{
      if (i < MAX_PARTIDOS){
        row[col_(headers,`p${i+1}`)-1] = normLEV_(p?.pronostico);
      }
    });

    // Banner de la jornada
    asegurarBannerJornada_(cfg);

    if (fila){
      sh.getRange(fila, 1, 1, row.length).setValues([row]);
    } else {
      sh.appendRow(row);
    }

    return json_({ ok:true });

  }catch(err){
    return json_({ ok:false, message:String(err) });
  }
}

/* ========= Formato visual: aciertos + ganadores ========= */
function aplicarFormatoJornada_(cfg){
  const sh = ss_().getSheetByName(SHEET_RESP);
  const lastRow = sh.getLastRow();
  const lastCol = sh.getLastColumn();
  if (lastRow < 3) return;

  const values = sh.getRange(1,1,lastRow,lastCol).getValues();
  const h = values[0];

  const cJ   = col_(h,'Jornada');
  const cA   = col_(h,'Aciertos');
  const cP1  = col_(h,'p1');
  const cTel = col_(h,'Teléfono');
  const cNom = col_(h,'Nombre');

  const numPicks = Math.min(cfg.partidos.length, MAX_PARTIDOS);

  let maxA = -1;
  for (let r=2; r<values.length; r++){
    if (esBannerRow_(values[r], cTel)) continue;
    const j = parseJornada_(values[r][cJ-1]);
    if (j === null || j !== cfg.jornada) continue;
    const ac = Number(values[r][cA-1]) || 0;
    if (ac > maxA) maxA = ac;
  }
  if (maxA < 0) maxA = 0;

  const dataRows = lastRow - 2;
  const rangoDatos = sh.getRange(3,1,dataRows,lastCol);
  const bgs = rangoDatos.getBackgrounds();

  for (let rr=0; rr<dataRows; rr++){
    const r = rr + 2;
    if (esBannerRow_(values[r], cTel)) continue;

    const j = parseJornada_(values[r][cJ-1]);
    if (j === null || j !== cfg.jornada) continue;

    const ac = Number(values[r][cA-1]) || 0;
    const esGanador = (ac === maxA);

    for (let c=0; c<lastCol; c++) bgs[rr][c] = COLOR_LIMPIO;

    if (esGanador){
      bgs[rr][cNom-1] = COLOR_ACIERTO; // SOLO nombre
    }

    for (let i=0; i<numPicks; i++){
      const pick = normLEV_(values[r][(cP1-1)+i]);
      const res  = normLEV_(cfg.resultados[i]);
      if (pick && res && pick === res){
        bgs[rr][(cP1-1)+i] = COLOR_ACIERTO;
      }
    }
  }

  rangoDatos.setBackgrounds(bgs);
}

/* ========= Calificar jornada actual ========= */
function calificarJornadaActual(){
  const cfg = readConfig_();
  if (!cfg.jornada) throw new Error('Jornada no definida en CONFIG (Subtitulo).');

  const sh = ss_().getSheetByName(SHEET_RESP);
  const values = sh.getDataRange().getValues();
  const h = values[0];

  const cJ   = col_(h,'Jornada');
  const cA   = col_(h,'Aciertos');
  const cNG  = col_(h,'NumGanadores');
  const cPP  = col_(h,'PremioPorGanador');
  const cP1  = col_(h,'p1');
  const cTel = col_(h,'Teléfono');

  const n = Math.min(cfg.partidos.length, MAX_PARTIDOS);

  let maxA = -1;
  const filas = [];

  for (let r=2; r<values.length; r++){
    if (esBannerRow_(values[r], cTel)) continue;

    let j = parseJornada_(values[r][cJ-1]);
    const tienePicks = String(values[r][cP1-1] ?? '').trim() !== '';
    if (j === null && tienePicks){
      j = cfg.jornada;
      values[r][cJ-1] = cfg.jornada;
    }

    if (j === null || j !== cfg.jornada) continue;

    let ac = 0;
    for (let i=0; i<n; i++){
      const pick = normLEV_(values[r][col_(h,`p${i+1}`)-1]);
      const res  = normLEV_(cfg.resultados[i]);
      if (pick && res && pick === res) ac++;
    }

    values[r][cA-1] = ac;
    filas.push(r);
    if (ac > maxA) maxA = ac;
  }

  const ganadores = filas.filter(r => Number(values[r][cA-1]) === maxA);
  const porGanador = ganadores.length ? (cfg.premioSemanal / ganadores.length) : 0;

  const setGanadores = new Set(ganadores);
  filas.forEach(r=>{
    if (setGanadores.has(r)){
      values[r][cNG-1] = ganadores.length;
      values[r][cPP-1] = porGanador;
    } else {
      values[r][cNG-1] = '';
      values[r][cPP-1] = '';
    }
  });

  sh.getRange(1,1,values.length,values[0].length).setValues(values);

  if (sh.getLastRow() > 2){
    sh.getRange(3,1,sh.getLastRow()-2,sh.getLastColumn())
      .sort([{column:cJ, ascending:false}, {column:cA, ascending:false}]);
  }

  aplicarFormatoJornada_(cfg);
  actualizarAcumulado_();
}

/* ========= ACUMULADO PODIO (empates incluidos) =========
   Podio | Nombre | Aciertos acumulados | Promedio de aciertos | Premios acumulados | J1..J17
   - Podio por GRUPOS: empates comparten lugar
   - Colorea celdas de PODIO y NOMBRE para lugares 1/2/3 (incluye empates)
   - Colorea en verde (COLOR_ACIERTO) las celdas Jx donde fue ganador de esa jornada
   - Alineación: todo centrado excepto Nombre (izquierda)
======================================================== */
function actualizarAcumulado_(){
  const sh = ss_().getSheetByName(SHEET_RESP);
  const lastRow = sh.getLastRow();
  const lastCol = sh.getLastColumn();
  if (lastRow < 3) return;

  const values = sh.getRange(1,1,lastRow,lastCol).getValues();
  const h = values[0];

  const cJ   = col_(h,'Jornada');
  const cA   = col_(h,'Aciertos');
  const cNom = col_(h,'Nombre');
  const cTel = col_(h,'Teléfono');
  const cTs  = col_(h,'Timestamp');
  const cPP  = col_(h,'PremioPorGanador');

  const maxPorJ = Array.from({length: ACUM_JORNADAS+1}, ()=>0);
  const map = new Map();

  for (let r=2; r<values.length; r++){
    const nombre = String(values[r][cNom-1] ?? '').trim();
    if (!nombre) continue;

    const tel = String(values[r][cTel-1] ?? '').trim();
    const ts  = String(values[r][cTs-1] ?? '').trim().toUpperCase();
    if (tel === BANNER_MARKER_TEL) continue;
    if (ts.startsWith('PARTIDOS JORNADA')) continue;
    if (nombre === '==PARTIDOS==') continue;

    const j = parseJornada_(values[r][cJ-1]);
    if (!Number.isFinite(j) || j < 1 || j > ACUM_JORNADAS) continue;

    const ac = Number(values[r][cA-1]);
    const aciertos = Number.isFinite(ac) ? ac : 0;

    const prem = Number(values[r][cPP-1]);
    const premio = Number.isFinite(prem) ? prem : 0;

    if (aciertos > maxPorJ[j]) maxPorJ[j] = aciertos;

    const key = normName_(nombre);
    if (!map.has(key)){
      map.set(key, {
        name: nombre, // ya viene en MAYÚSCULAS sin acentos
        totalA: 0,
        totalPrem: 0,
        jugadas: new Set(),
        porJ: Array.from({length: ACUM_JORNADAS+1}, ()=>null),
      });
    }

    const obj = map.get(key);
    obj.totalA += aciertos;
    obj.totalPrem += premio;
    obj.jugadas.add(j);

    const prev = obj.porJ[j];
    if (prev === null || aciertos > prev) obj.porJ[j] = aciertos;
  }

  const headers = [
    'Podio',
    'Nombre',
    'Aciertos acumulados',
    'Promedio de aciertos',
    'Premios acumulados',
    ...Array.from({length: ACUM_JORNADAS}, (_,i)=>`J${i+1}`)
  ];

  const rows = Array.from(map.values()).map(o => {
    const jj = o.jugadas.size;
    const prom = jj ? (o.totalA / jj) : 0;

    const porJ = [];
    for (let j=1; j<=ACUM_JORNADAS; j++){
      porJ.push(o.porJ[j] === null ? '' : o.porJ[j]);
    }

    return ['', o.name, o.totalA, prom, o.totalPrem, ...porJ];
  });

  // Orden: aciertos desc, luego premios desc, luego nombre
  rows.sort((a,b) => (b[2]-a[2]) || (b[4]-a[4]) || String(a[1]).localeCompare(String(b[1])));

  // Podio por GRUPOS (empates comparten lugar)
  // ✅ Podio por GRUPOS usando SOLO "Aciertos acumulados"
// (empate = mismo total de aciertos, aunque tengan premios distintos)
let rank = 0;
let prevAciertos = null;

for (let i=0; i<rows.length; i++){
  const acA = Number(rows[i][2]) || 0;

  if (prevAciertos === null || acA !== prevAciertos){
    rank += 1;
    prevAciertos = acA;
  }

  rows[i][0] = (rank <= 3) ? rank : '';
}

  const startRow = 1;
  const startCol = ACUM_COL_START;

  sh.getRange(startRow, startCol, 1, 1).setValues([['ACUMULADO']]).setFontWeight('bold');
  sh.getRange(startRow+1, startCol, 1, headers.length).setValues([headers]).setFontWeight('bold');

  const maxClearRows = Math.max(rows.length + 10, 80);
  sh.getRange(startRow+2, startCol, maxClearRows, headers.length).clearContent().clearFormat();

  if (rows.length){
    sh.getRange(startRow+2, startCol, rows.length, headers.length).setValues(rows);

    sh.getRange(startRow+2, startCol+2, rows.length, 1).setNumberFormat('0');
    sh.getRange(startRow+2, startCol+3, rows.length, 1).setNumberFormat('0.00');
    sh.getRange(startRow+2, startCol+4, rows.length, 1).setNumberFormat('$#,##0.00');
    sh.getRange(startRow+2, startCol+5, rows.length, ACUM_JORNADAS).setNumberFormat('0');

    sh.getRange(startRow+2, startCol, rows.length, headers.length)
      .setHorizontalAlignment('center')
      .setVerticalAlignment('middle');

    sh.getRange(startRow+2, startCol+1, rows.length, 1)
      .setHorizontalAlignment('left');
  }

  const totalRows = 2 + Math.max(rows.length,1);
  sh.getRange(startRow, startCol, totalRows, headers.length)
    .setBorder(true,true,true,true,true,true);

  // Ganadores por jornada (celdas Jx)
  if (rows.length){
    const jStartCol = startCol + 5;
    const bgJ = sh.getRange(startRow+2, jStartCol, rows.length, ACUM_JORNADAS).getBackgrounds();

    for (let r=0; r<rows.length; r++){
      for (let j=1; j<=ACUM_JORNADAS; j++){
        const val = rows[r][4 + j];
        const num = Number(val);
        if (Number.isFinite(num) && num > 0 && num === maxPorJ[j]){
          bgJ[r][j-1] = COLOR_ACIERTO;
        }
      }
    }
    sh.getRange(startRow+2, jStartCol, rows.length, ACUM_JORNADAS).setBackgrounds(bgJ);
  }

  // Colorear celdas PODIO y NOMBRE para podio 1/2/3 (incluye empates)
  if (rows.length){
    const rangePodio  = sh.getRange(startRow+2, startCol,   rows.length, 1); // Podio
    const rangeNombre = sh.getRange(startRow+2, startCol+1, rows.length, 1); // Nombre

    const bgP = rangePodio.getBackgrounds();
    const bgN = rangeNombre.getBackgrounds();

    for (let r=0; r<rows.length; r++){
      const p = Number(rows[r][0]);
      let color = null;
      if (p === 1) color = COLOR_TOP1;
      else if (p === 2) color = COLOR_TOP2;
      else if (p === 3) color = COLOR_TOP3;

      if (color){
        bgP[r][0] = color;
        bgN[r][0] = color;
      }
    }

    rangePodio.setBackgrounds(bgP);
    rangeNombre.setBackgrounds(bgN);
  }
}

// Wrapper visible en el menú de ejecutar (sin underscore)
function actualizarAcumulado(){
  actualizarAcumulado_();
}
